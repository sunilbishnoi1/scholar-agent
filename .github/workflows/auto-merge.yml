# Auto-merge develop to main after all tests pass
# This workflow ensures that only validated code reaches production

name: Auto Merge to Main

on:
  push:
    branches: [develop]
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    branches: [develop]
    types: [completed]

jobs:
  auto-merge:
    name: Merge develop to main
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Wait for CI to complete (if triggered by push)
        if: github.event_name == 'push'
        run: |
          echo "Waiting for CI/CD Pipeline to complete..."
          sleep 30

          # Get the current commit SHA
          COMMIT_SHA="${{ github.sha }}"

          # Wait for CI to complete (max 20 minutes)
          for i in {1..40}; do
            # Get all workflow runs for this commit
            RUNS=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/actions/runs?head_sha=$COMMIT_SHA&event=push")
            
            # Check if CI/CD Pipeline completed
            STATUS=$(echo "$RUNS" | jq -r '.workflow_runs[] | select(.name == "CI/CD Pipeline") | .status')
            CONCLUSION=$(echo "$RUNS" | jq -r '.workflow_runs[] | select(.name == "CI/CD Pipeline") | .conclusion')
            
            echo "CI Status: $STATUS, Conclusion: $CONCLUSION"
            
            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "‚úÖ CI/CD Pipeline passed!"
                echo "CI_PASSED=true" >> $GITHUB_ENV
                break
              else
                echo "‚ùå CI/CD Pipeline failed with conclusion: $CONCLUSION"
                echo "CI_PASSED=false" >> $GITHUB_ENV
                break
              fi
            fi
            
            echo "Waiting for CI/CD Pipeline... ($i/40)"
            sleep 30
          done

          if [ -z "$STATUS" ] || [ "$STATUS" != "completed" ]; then
            echo "‚è±Ô∏è CI/CD Pipeline did not complete in time"
            echo "CI_PASSED=false" >> $GITHUB_ENV
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set CI status from workflow_run
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            echo "CI_PASSED=true" >> $GITHUB_ENV
          else
            echo "CI_PASSED=false" >> $GITHUB_ENV
          fi

      - name: Merge develop to main
        if: env.CI_PASSED == 'true'
        run: |
          echo "Fetching latest changes..."
          git fetch origin develop
          git fetch origin main

          echo "Checking out main..."
          git checkout main
          git pull origin main

          echo "Merging develop into main..."
          if git merge origin/develop --no-ff -m "Auto-merge develop to main after successful CI"; then
            echo "‚úÖ Merge successful!"
            
            echo "Pushing to main..."
            git push origin main
            
            echo "‚úÖ Successfully merged and pushed to main!"
            echo "üöÄ Production deployment will now trigger via CI/CD Pipeline"
          else
            echo "‚ùå Merge conflict detected. Manual resolution required."
            exit 1
          fi

      - name: Report failure
        if: env.CI_PASSED != 'true'
        run: |
          echo "‚ùå Cannot merge to main: CI/CD Pipeline did not pass"
          echo "Please check the CI/CD Pipeline results and fix any issues"
          exit 1

      - name: Comment on commit (on failure)
        if: failure()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="‚ùå Auto-merge to main failed. Please check the workflow logs for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Auto-merge develop to main after all tests pass
# This workflow creates a PR and uses GitHub's auto-merge feature
# to respect branch protection rules on main
#
# NOTE: Only triggered by workflow_run (not push) to avoid:
# 1. Holding a runner hostage while polling for CI completion
# 2. Duplicate runs (push + workflow_run would trigger twice)
# 3. Resource contention that can cause job cancellations

name: Auto Merge to Main

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    branches: [develop]
    types: [completed]

jobs:
  auto-merge:
    name: Create PR and Auto-Merge to main
    runs-on: ubuntu-latest
    # Only run if CI passed - workflow_run always provides conclusion
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or Update PR and Merge
        run: |
          echo "✅ CI/CD Pipeline passed! Creating/updating PR..."
          echo "Checking for existing PR from develop to main..."

          # Check if a PR already exists
          EXISTING_PR=$(gh pr list --base main --head develop --json number,state --jq '.[] | select(.state == "OPEN") | .number')

          if [ -n "$EXISTING_PR" ]; then
            echo "Found existing PR #$EXISTING_PR"
            PR_NUMBER=$EXISTING_PR
          else
            echo "Creating new PR from develop to main..."
            # Use the workflow_run's head SHA for accurate commit reference
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "Auto-merge: develop → main (CI passed)" \
              --body "## Automated PR

          This PR was automatically created after all CI/CD checks passed on the \`develop\` branch.

          **Commit:** $COMMIT_SHA
          **Triggered by:** workflow_run (CI/CD Pipeline success)

          ---
          *This PR will be automatically merged if all branch protection requirements are met.*")
            
            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            echo "Created PR #$PR_NUMBER"
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

          # Wait a moment for PR to be fully created
          sleep 5

          # Try to merge the PR
          echo "Attempting to merge PR #$PR_NUMBER..."
          if gh pr merge "$PR_NUMBER" --merge --auto; then
            echo "✅ Auto-merge enabled for PR #$PR_NUMBER"
          else
            # If auto-merge fails (e.g., not enabled in repo), try direct merge
            echo "Auto-merge not available, attempting direct merge..."
            if gh pr merge "$PR_NUMBER" --merge; then
              echo "✅ PR #$PR_NUMBER merged successfully!"
            else
              echo "⚠️ Could not merge PR automatically. PR #$PR_NUMBER is ready for manual review."
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on commit (on failure)
        if: failure()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/comments \
            -f body="❌ Auto-merge to main failed. Please check the workflow logs for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Auto-merge develop to main after all tests pass
# This workflow creates a PR, merges it, and DEPLOYS to production
# Version: 1.1

name: Auto Merge to Main

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    branches: [develop]
    types: [completed]

env:
  NODE_VERSION: "20"

jobs:
  auto-merge:
    name: Create PR and Auto-Merge to main
    runs-on: ubuntu-latest
    # Only run if CI passed - workflow_run always provides conclusion
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write
      pull-requests: write
    outputs:
      merged: ${{ steps.merge.outputs.merged }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or Update PR and Merge
        id: merge
        run: |
          echo "‚úÖ CI/CD Pipeline passed! Creating/updating PR..."
          echo "Checking for existing PR from develop to main..."

          # Check if a PR already exists
          EXISTING_PR=$(gh pr list --base main --head develop --json number,state --jq '.[] | select(.state == "OPEN") | .number')

          if [ -n "$EXISTING_PR" ]; then
            echo "Found existing PR #$EXISTING_PR"
            PR_NUMBER=$EXISTING_PR
          else
            echo "Creating new PR from develop to main..."
            # Use the workflow_run's head SHA for accurate commit reference
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "Auto-merge: develop ‚Üí main (CI passed)" \
              --body "## Automated PR

          This PR was automatically created after all CI/CD checks passed on the \`develop\` branch.

          **Commit:** $COMMIT_SHA
          **Triggered by:** workflow_run (CI/CD Pipeline success)

          ---
          *This PR will be automatically merged if all branch protection requirements are met.*")
            
            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            echo "Created PR #$PR_NUMBER"
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

          # Wait a moment for PR to be fully created
          sleep 5

          # Try to merge the PR
          echo "Attempting to merge PR #$PR_NUMBER..."
          MERGED=false
          if gh pr merge "$PR_NUMBER" --merge --auto; then
            echo "‚úÖ Auto-merge enabled for PR #$PR_NUMBER"
            # Wait for auto-merge to complete
            sleep 10
            # Check if it actually merged
            PR_STATE=$(gh pr view "$PR_NUMBER" --json state --jq '.state')
            if [ "$PR_STATE" = "MERGED" ]; then
              MERGED=true
            fi
          else
            # If auto-merge fails (e.g., not enabled in repo), try direct merge
            echo "Auto-merge not available, attempting direct merge..."
            if gh pr merge "$PR_NUMBER" --merge; then
              echo "‚úÖ PR #$PR_NUMBER merged successfully!"
              MERGED=true
            else
              echo "‚ö†Ô∏è Could not merge PR automatically. PR #$PR_NUMBER is ready for manual review."
            fi
          fi

          echo "merged=$MERGED" >> $GITHUB_OUTPUT
          echo "Merge status: $MERGED"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on commit (on failure)
        if: failure()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/comments \
            -f body="‚ùå Auto-merge to main failed. Please check the workflow logs for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # Deploy to Production after merge
  # ==========================================
  # CRITICAL: This job runs deployment because GITHUB_TOKEN merges
  # do NOT trigger subsequent workflows (GitHub's infinite loop prevention).
  # We deploy here since CI already passed on develop.
  # ==========================================
  # Deploy Backend to Production after merge
  # ==========================================
  deploy-backend-production:
    name: Deploy Backend to Production
    needs: auto-merge
    if: needs.auto-merge.outputs.merged == 'true'
    runs-on: ubuntu-latest
    environment:
      name: scholar-backend
      url: https://dashboard.render.com/web/${{ vars.RENDER_SERVICE_ID }}

    steps:
      - name: Checkout code (main branch)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Deploy Backend to Render
        id: deploy-backend
        run: |
          echo "üöÄ Deploying backend to production..."

          if [ -z "${{ vars.RENDER_SERVICE_ID }}" ]; then
            echo "‚ö†Ô∏è RENDER_SERVICE_ID not configured, skipping backend deployment"
            exit 0
          fi

          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/${{ vars.RENDER_SERVICE_ID }}/deploys")

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Production backend deployment triggered successfully (HTTP $http_code)"
          else
            echo "‚ùå Failed to trigger production backend deployment (HTTP $http_code)"
            exit 1
          fi
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

  # ==========================================
  # Deploy Frontend to Production after merge
  # ==========================================
  deploy-frontend-production:
    name: Deploy Frontend to Production
    needs: auto-merge
    if: needs.auto-merge.outputs.merged == 'true'
    runs-on: ubuntu-latest
    environment:
      name: Production
      url: https://vercel.com/${{ vars.VERCEL_ORG_ID }}/${{ vars.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout code (main branch)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js for Vercel CLI
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy Frontend to Vercel (Production)
        run: |
          echo "üöÄ Deploying frontend to Vercel production..."
          npm install -g vercel@latest

          # Deploy with explicit environment variables ensuring Vercel ignores local config
          vercel deploy --prod --yes --token "${{ secrets.VERCEL_TOKEN }}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deployment Summary
        run: |
          echo "========================================="
          echo "üéâ PRODUCTION DEPLOYMENT COMPLETE"
          echo "========================================="
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "Backend: Render"
          echo "Frontend: Vercel"
          echo "========================================="
